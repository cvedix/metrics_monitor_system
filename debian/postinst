#!/bin/sh
set -e

# Post-installation script for metrics-monitor-system

# Create /opt/cvedix/monitor directory if it doesn't exist
if [ ! -d /opt/cvedix/monitor ]; then
    mkdir -p /opt/cvedix/monitor
fi

# Set proper permissions
chmod 755 /opt/cvedix/monitor/metrics_monitor_system
chmod 644 /opt/cvedix/monitor/*.json 2>/dev/null || true

# Copy example config if config.json doesn't exist
if [ ! -f /opt/cvedix/monitor/config.json ]; then
    if [ -f /opt/cvedix/monitor/config.json.example ]; then
        cp /opt/cvedix/monitor/config.json.example /opt/cvedix/monitor/config.json
        chmod 644 /opt/cvedix/monitor/config.json
        echo "Created /opt/cvedix/monitor/config.json from example"
    fi
fi

# Ensure symlink exists
if [ ! -L /usr/bin/metrics_monitor_system ]; then
    ln -sf /opt/cvedix/monitor/metrics_monitor_system /usr/bin/metrics_monitor_system
fi

# Reload systemd and enable service
if [ -f /lib/systemd/system/metrics-monitor-system.service ]; then
    systemctl daemon-reload >/dev/null 2>&1 || true
    # Don't auto-start on install, let user start manually
    # systemctl enable metrics-monitor-system >/dev/null 2>&1 || true
    # systemctl start metrics-monitor-system >/dev/null 2>&1 || true
fi

echo "metrics-monitor-system installed successfully!"
echo "Installation directory: /opt/cvedix/monitor"
echo "Configuration file: /opt/cvedix/monitor/config.json"
echo ""
echo "To start the service:"
echo "  sudo systemctl start metrics-monitor-system"
echo "To enable auto-start on boot:"
echo "  sudo systemctl enable metrics-monitor-system"
echo "To check status:"
echo "  sudo systemctl status metrics-monitor-system"

# DEBHELPER#
exit 0

