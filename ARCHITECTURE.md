# Kiến trúc Hệ thống Metrics Monitor System

## Sơ đồ Kiến trúc Tổng quan

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BUILD ENVIRONMENT                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────┐      ┌──────────────────────────┐           │
│  │  Native Build            │      │  Cross-Compile           │           │
│  │  (arm64 Debian/Ubuntu)   │      │  (x86_64 → arm64)        │           │
│  └──────────┬───────────────┘      └──────────┬───────────────┘           │
│             │                                  │                            │
│             └──────────────┬───────────────────┘                            │
│                            │                                                │
│                            ▼                                                │
│                  ┌─────────────────────┐                                   │
│                  │  Debian Package      │                                   │
│                  │  (.deb)             │                                   │
│                  └──────────┬──────────┘                                   │
│                             │                                               │
└─────────────────────────────┼───────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      TARGET DEVICE (arm64)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                    ┌─────────────────────┐                                 │
│                    │  Installation       │                                 │
│                    │  (dpkg -i)          │                                 │
│                    └─────┬───────────────┘                                 │
│                          │                                                 │
│         ┌─────────────────┼─────────────────┬──────────────┐              │
│         │                 │                 │              │              │
│         ▼                 ▼                 ▼              ▼              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────┐  ┌──────────────┐     │
│  │ Systemd      │  │ Binary       │  │ Config   │  │ Config       │     │
│  │ Service      │  │ /opt/cvedix/ │  │ Files    │  │ Files        │     │
│  │              │  │ monitor/     │  │          │  │              │     │
│  └──────┬───────┘  └──────┬───────┘  └────┬─────┘  └──────┬───────┘     │
│         │                 │                │               │              │
│         │                 │                │               │              │
│         │                 │         ┌──────┴──────┐        │              │
│         │                 │         │            │        │              │
│         │                 │         ▼            ▼        │              │
│         │                 │    ┌──────────┐ ┌──────────┐  │              │
│         │                 │    │ config.  │ │ device_  │  │              │
│         │                 │    │ json     │ │ config.  │  │              │
│         │                 │    │          │ │ json     │  │              │
│         │                 │    └──────────┘ └──────────┘  │              │
│         │                 │                                │              │
│         └─────────┬───────┴────────────────────────────────┘              │
│                   │                                                        │
│                   ▼                                                        │
│         ┌─────────────────────────────┐                                    │
│         │  Metrics Monitor System     │                                    │
│         │  HTTP Server                │                                    │
│         └──────────────┬──────────────┘                                    │
│                        │                                                   │
└────────────────────────┼───────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CORE COMPONENTS                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────┐  ┌──────────────────────┐                        │
│  │ System Info Module   │  │ System Status       │                        │
│  │ (hwinfo library)     │  │ Module              │                        │
│  └──────────┬───────────┘  └──────────┬───────────┘                        │
│             │                          │                                    │
│             ▼                          ▼                                    │
│  ┌──────────────────────┐  ┌──────────────────────┐                        │
│  │ Hardware Info        │  │ Real-time Status     │                        │
│  │ (CPU, RAM, GPU,      │  │ (CPU usage, RAM      │                        │
│  │  Disk, Mainboard,    │  │  usage, Disk usage,  │                        │
│  │  OS)                 │  │  Uptime)             │                        │
│  └──────────────────────┘  └──────────────────────┘                        │
│                                                                             │
│  ┌──────────────────────┐  ┌──────────────────────┐                        │
│  │ Device Config        │  │ Config Loader        │                        │
│  │ Module               │  │                      │                        │
│  └──────────┬───────────┘  └──────────────────────┘                        │
│             │                                                               │
│             ▼                                                               │
│  ┌──────────────────────┐                                                  │
│  │ Device Registration  │                                                  │
│  │ & Configuration      │                                                  │
│  └──────────────────────┘                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          API ENDPOINTS                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  • GET  /v1/core/system/info                                               │
│  • POST /v1/core/system/info (Basic Auth)                                  │
│  • GET  /v1/core/system/status                                              │
│  • POST /v1/core/system/reboot                                              │
│  • GET  /health                                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                         ▲
                         │
┌─────────────────────────┼───────────────────────────────────────────────────┐
│                         │         REMOTE MANAGEMENT                        │
├─────────────────────────┼───────────────────────────────────────────────────┤
│                         │                                                   │
│         ┌───────────────┴───────────────┐                                  │
│         │                               │                                  │
│         ▼                               ▼                                  │
│  ┌──────────────────┐          ┌──────────────────┐                        │
│  │ Remote Admin/    │          │ OTA Update       │                        │
│  │ Client           │          │ Server           │                        │
│  │                  │          │                  │                        │
│  │ HTTP/HTTPS       │          │ Download &       │                        │
│  │ Requests         │          │ Install          │                        │
│  └──────────────────┘          └──────────────────┘                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                         ▲
                         │
┌─────────────────────────┼───────────────────────────────────────────────────┐
│                         │         SYSTEM INTEGRATION                       │
├─────────────────────────┼───────────────────────────────────────────────────┤
│                         │                                                   │
│                         ▼                                                   │
│              ┌──────────────────────┐                                       │
│              │  Systemd Service     │                                       │
│              │                      │                                       │
│              │  • systemctl status │                                       │
│              │  • systemctl logs   │                                       │
│              │  • systemctl restart│                                       │
│              │  • Lifecycle Mgmt   │                                       │
│              └──────────────────────┘                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Sơ đồ Luồng Dữ liệu

### 1. Device Registration Flow

```
┌──────────────┐         ┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   Client     │         │  API Server │         │   Config    │         │   Device     │
│  (Admin)     │         │             │         │   Module    │         │   Config     │
└──────┬───────┘         └──────┬───────┘         └──────┬───────┘         └──────┬───────┘
       │                        │                        │                        │
       │ POST /v1/core/system/  │                        │                        │
       │ info (Basic Auth)      │                        │                        │
       ├───────────────────────>│                        │                        │
       │                        │                        │                        │
       │                        │ Validate Authentication│                        │
       │                        ├───────────────────────>│                        │
       │                        │                        │                        │
       │                        │                        │ Register/Update        │
       │                        │                        │ Device Info            │
       │                        ├─────────────────────────────────────────────────>│
       │                        │                        │                        │
       │                        │                        │                        │ Success
       │                        │<─────────────────────────────────────────────────┤
       │                        │                        │                        │
       │                        │                        │                        │
       │ Device Registered      │                        │                        │
       │<───────────────────────┤                        │                        │
       │                        │                        │                        │
```

### 2. System Information Query

```
┌──────────────┐         ┌──────────────┐         ┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   Client     │         │  API Server │         │ System Info  │         │   Device     │         │  Hardware    │
│              │         │             │         │   Module     │         │   Config     │         │  (hwinfo)     │
└──────┬───────┘         └──────┬───────┘         └──────┬───────┘         └──────┬───────┘         └──────┬───────┘
       │                        │                        │                        │                        │
       │ GET /v1/core/system/   │                        │                        │                        │
       │ info                   │                        │                        │                        │
       ├───────────────────────>│                        │                        │                        │
       │                        │                        │                        │                        │
       │                        │ Get System Information│                        │                        │
       │                        ├───────────────────────>│                        │                        │
       │                        │                        │                        │                        │
       │                        │                        │ Query Hardware Info    │                        │
       │                        │                        ├───────────────────────────────────────────────>│
       │                        │                        │                        │                        │
       │                        │                        │                        │                        │ CPU, RAM, GPU,
       │                        │                        │                        │                        │ Disk, etc.
       │                        │                        │<───────────────────────────────────────────────┤
       │                        │                        │                        │                        │
       │                        │                        │ Get Device Config      │                        │
       │                        │                        ├───────────────────────>│                        │
       │                        │                        │                        │                        │
       │                        │                        │                        │ Device Metadata        │
       │                        │                        │<───────────────────────┤                        │
       │                        │                        │                        │                        │
       │                        │                        │ Combined JSON Response │                        │
       │                        │<───────────────────────┤                        │                        │
       │                        │                        │                        │                        │
       │ System Information      │                        │                        │                        │
       │<───────────────────────┤                        │                        │                        │
       │                        │                        │                        │                        │
```

### 3. System Status Monitoring

```
┌──────────────┐         ┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   Client     │         │  API Server │         │ System Status│         │  Hardware    │
│              │         │             │         │   Module     │         │  (hwinfo)     │
└──────┬───────┘         └──────┬───────┘         └──────┬───────┘         └──────┬───────┘
       │                        │                        │                        │
       │ GET /v1/core/system/   │                        │                        │
       │ status                 │                        │                        │
       ├───────────────────────>│                        │                        │
       │                        │                        │                        │
       │                        │ Get Current Status     │                        │
       │                        ├───────────────────────>│                        │
       │                        │                        │                        │
       │                        │                        │ Query Real-time        │
       │                        │                        │ Metrics                │
       │                        │                        ├───────────────────────>│
       │                        │                        │                        │
       │                        │                        │                        │ CPU usage, RAM
       │                        │                        │                        │ usage, etc.
       │                        │                        │<───────────────────────┤
       │                        │                        │                        │
       │                        │                        │ Status JSON            │
       │                        │<───────────────────────┤                        │
       │                        │                        │                        │
       │ System Status           │                        │                        │
       │<───────────────────────┤                        │                        │
       │                        │                        │                        │
```

### 4. System Control (Reboot)

```
┌──────────────┐         ┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   Client     │         │  API Server │         │   Config    │         │   System     │
│  (Admin)     │         │             │         │   Module    │         │              │
└──────┬───────┘         └──────┬───────┘         └──────┬───────┘         └──────┬───────┘
       │                        │                        │                        │
       │ POST /v1/core/system/  │                        │                        │
       │ reboot (Authenticated) │                        │                        │
       ├───────────────────────>│                        │                        │
       │                        │                        │                        │
       │                        │ Validate Authentication│                        │
       │                        ├───────────────────────>│                        │
       │                        │                        │                        │
       │                        │                        │                        │ Execute Reboot
       │                        │                        │                        │ Command
       │                        ├─────────────────────────────────────────────────>│
       │                        │                        │                        │
       │                        │                        │                        │
       │ Reboot Initiated        │                        │                        │
       │<───────────────────────┤                        │                        │
       │                        │                        │                        │
```

## Sơ đồ Cấu trúc Package

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Debian Package Structure                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                    ┌─────────────────────────────┐                          │
│                    │ metrics-monitor-system.deb  │                          │
│                    └───────────┬─────────────────┘                          │
│                                │                                             │
│        ┌───────────────────────┼───────────────────────┬──────────────┐     │
│        │                       │                       │              │     │
│        ▼                       ▼                       ▼              ▼     │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐ ┌─────────┐│
│  │ /opt/cvedix/ │      │  /usr/bin/   │      │ /usr/share/  │ │  /etc/  ││
│  │ monitor/     │      │              │      │ doc/         │ │         ││
│  └──────┬───────┘      └──────┬───────┘      └──────┬───────┘ └────┬────┘│
│         │                     │                      │              │     │
│         │                     │                      │              │     │
│    ┌────┴────┬──────────┬─────┘                      │              │     │
│    │         │          │                            │              │     │
│    ▼         ▼          ▼                            ▼              ▼     │
│  ┌──────┐ ┌──────┐ ┌──────────┐              ┌──────────┐ ┌──────────┐  │
│  │metrics│ │config│ │device_   │              │ README.md│ │device_   │  │
│  │_monitor│ │.json │ │config.   │              │          │ │registered│  │
│  │_system│ │.examp│ │example.  │              │DEBIAN_   │ │.json     │  │
│  │(binary)│ │le    │ │json      │              │PACKAGE.md│ │(runtime) │  │
│  └──────┘ └──────┘ └──────────┘              └──────────┘ └──────────┘  │
│                                                                             │
│    ┌──────────────┐                                                       │
│    │ metrics_     │                                                       │
│    │ monitor_     │                                                       │
│    │ system       │                                                       │
│    │ (symlink)    │                                                       │
│    └──────────────┘                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Sơ đồ Build & Deployment

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          BUILD OPTIONS                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────┐      ┌──────────────────────────┐           │
│  │  Native Build            │      │  Cross-Compile           │           │
│  │  arm64 Debian/Ubuntu     │      │  x86_64 → arm64          │           │
│  └──────────┬───────────────┘      └──────────┬───────────────┘           │
│             │                                  │                            │
│             └──────────────┬───────────────────┘                            │
│                            │                                                │
│                            ▼                                                │
│              ┌─────────────────────────┐                                   │
│              │  CMake Build System      │                                   │
│              └──────────┬───────────────┘                                   │
│                         │                                                  │
│                         ▼                                                  │
│              ┌─────────────────────────┐                                   │
│              │  build_deb.sh            │                                   │
│              └──────────┬───────────────┘                                   │
│                         │                                                  │
│                         ▼                                                  │
│              ┌─────────────────────────┐                                   │
│              │  Debian Package         │                                   │
│              │  (.deb file)            │                                   │
│              └──────────┬───────────────┘                                   │
│                         │                                                  │
└─────────────────────────┼───────────────────────────────────────────────────┘
                          │
                          │
┌─────────────────────────┼───────────────────────────────────────────────────┐
│                         │         DEPENDENCIES                             │
├─────────────────────────┼───────────────────────────────────────────────────┤
│                         │                                                   │
│  ┌──────────────────────┼──────────────────────┐                            │
│  │                      │                      │                            │
│  ▼                      ▼                      ▼                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                     │
│  │ hwinfo        │  │ cpp-httplib  │  │ CMake >= 3.15│                     │
│  │ library       │  │              │  │              │                     │
│  │ (third_party/ │  │ (third_party/│  │ C++17        │                     │
│  │  hwinfo)      │  │  cpp-httplib)│  │ Compiler     │                     │
│  └──────────────┘  └──────────────┘  └──────────────┘                     │
│         │                  │                  │                              │
│         └──────────────────┴──────────────────┘                              │
│                            │                                                 │
│                            ▼                                                 │
│              ┌─────────────────────────┐                                    │
│              │  CMake Build System      │                                    │
│              └─────────────────────────┘                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        DEPLOYMENT PROCESS                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│              ┌─────────────────────────┐                                   │
│              │  Deploy to Target Device │                                   │
│              └──────────┬───────────────┘                                   │
│                         │                                                  │
│                         ▼                                                  │
│              ┌─────────────────────────┐                                   │
│              │  Install via dpkg       │                                   │
│              │  (dpkg -i *.deb)        │                                   │
│              └──────────┬───────────────┘                                   │
│                         │                                                  │
│                         ▼                                                  │
│              ┌─────────────────────────┐                                   │
│              │  Configure & Start      │                                   │
│              │  Service                │                                   │
│              └──────────┬───────────────┘                                   │
│                         │                                                  │
│                         ▼                                                  │
│              ┌─────────────────────────┐                                   │
│              │  Systemd Integration    │                                   │
│              │  (systemctl enable)     │                                   │
│              └──────────┬───────────────┘                                   │
│                         │                                                  │
│                         ▼                                                  │
│              ┌─────────────────────────┐                                   │
│              │  Running Service        │                                   │
│              │  ✓ Active & Running     │                                   │
│              └─────────────────────────┘                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Sơ đồ Kiến trúc OTA (Over-The-Air Updates)

### 1. Kiến trúc Tổng quan OTA

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         OTA UPDATE SERVER                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────┐      ┌──────────────────────┐                   │
│  │  Update Repository   │      │  Version Manager     │                   │
│  │                      │      │                      │                   │
│  │  • Package Storage   │      │  • Version Control  │                   │
│  │  • Metadata          │      │  • Release Notes     │                   │
│  │  • Checksums         │      │  • Compatibility    │                   │
│  └──────────┬───────────┘      └──────────┬───────────┘                   │
│             │                               │                               │
│             └───────────────┬─────────────────┘                               │
│                             │                                                 │
│                             ▼                                                 │
│              ┌──────────────────────────────┐                                 │
│              │  OTA API Endpoint           │                                 │
│              │  (HTTP/HTTPS)               │                                 │
│              │                              │                                 │
│              │  • Check Updates             │                                 │
│              │  • Download Package          │                                 │
│              │  • Verify Signature          │                                 │
│              └──────────────┬───────────────┘                                 │
│                             │                                                 │
└─────────────────────────────┼─────────────────────────────────────────────────┘
                              │
                              │ HTTP/HTTPS
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      TARGET DEVICE (arm64)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  Metrics Monitor System                                      │          │
│  │  (Current Running Version)                                   │          │
│  └──────────────────┬───────────────────────────────────────────┘          │
│                     │                                                       │
│                     ▼                                                       │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  OTA Update Client                                           │          │
│  │                                                              │          │
│  │  • Check for Updates                                         │          │
│  │  • Download Package                                          │          │
│  │  • Verify Integrity                                          │          │
│  │  • Install Update                                            │          │
│  │  • Rollback on Failure                                       │          │
│  └──────────────────┬───────────────────────────────────────────┘          │
│                     │                                                       │
│         ┌───────────┼───────────┬───────────────┐                         │
│         │           │           │               │                         │
│         ▼           ▼           ▼               ▼                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐                │
│  │ Download │ │ Verify   │ │ Install │ │ Version      │                │
│  │ Manager  │ │ Manager  │ │ Manager │ │ Manager      │                │
│  └────┬─────┘ └────┬─────┘ └────┬────┘ └──────┬───────┘                │
│       │            │            │              │                         │
│       │            │            │              │                         │
│       ▼            ▼            ▼              ▼                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐                │
│  │ /tmp/    │ │ Checksum │ │ dpkg -i   │ │ /var/lib/    │                │
│  │ updates/ │ │ Verify   │ │ *.deb    │ │ metrics-     │                │
│  │          │ │          │ │          │ │ monitor/     │                │
│  │          │ │          │ │          │ │ versions/    │                │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────┘                │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  Backup & Rollback System                                    │          │
│  │                                                              │          │
│  │  • Backup Current Version                                   │          │
│  │  • Store Previous Config                                     │          │
│  │  • Rollback on Failure                                      │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  Systemd Service Integration                                  │          │
│  │                                                              │          │
│  │  • systemctl stop metrics-monitor-system                     │          │
│  │  • Install New Package                                       │          │
│  │  • systemctl start metrics-monitor-system                    │          │
│  │  • systemctl status (verify)                                  │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2. Quy trình OTA Update

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        OTA UPDATE WORKFLOW                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  STEP 1: Check for Updates                                                 │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  Device → OTA Server: GET /api/v1/updates/check              │          │
│  │  Headers: Device-ID, Current-Version                         │          │
│  │                                                              │          │
│  │  Response: {                                                 │          │
│  │    "update_available": true,                                 │          │
│  │    "latest_version": "1.2.0",                               │          │
│  │    "download_url": "https://.../v1.2.0.deb",                │          │
│  │    "checksum": "sha256:...",                                 │          │
│  │    "size": 1024000,                                          │          │
│  │    "release_notes": "..."                                    │          │
│  │  }                                                           │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
│                              ▼                                              │
│                                                                             │
│  STEP 2: Download Package                                                  │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  Device → OTA Server: GET /api/v1/updates/download            │          │
│  │  Download to: /tmp/updates/metrics-monitor-system_1.2.0.deb  │          │
│  │                                                              │          │
│  │  Progress Tracking:                                          │          │
│  │  • Resume on failure                                         │          │
│  │  • Verify size during download                               │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
│                              ▼                                              │
│                                                                             │
│  STEP 3: Verify Integrity                                                  │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  • Calculate SHA256 checksum                                │          │
│  │  • Compare with server checksum                             │          │
│  │  • Verify package signature (if signed)                     │          │
│  │  • Check package format and structure                       │          │
│  │                                                              │          │
│  │  If verification fails → Abort & Report Error                │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
│                              ▼                                              │
│                                                                             │
│  STEP 4: Backup Current Version                                           │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  • Backup binary: /opt/cvedix/monitor/metrics_monitor_system │          │
│  │  • Backup config: /opt/cvedix/monitor/config.json           │          │
│  │  • Backup device config: /etc/device_registered.json        │          │
│  │  • Store version info: /var/lib/metrics-monitor/versions/   │          │
│  │                                                              │          │
│  │  Backup Location: /var/lib/metrics-monitor/backup/          │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
│                              ▼                                              │
│                                                                             │
│  STEP 5: Stop Service                                                      │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  systemctl stop metrics-monitor-system                       │          │
│  │  • Wait for graceful shutdown                                │          │
│  │  • Verify service stopped                                    │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
│                              ▼                                              │
│                                                                             │
│  STEP 6: Install New Package                                               │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  dpkg -i /tmp/updates/metrics-monitor-system_1.2.0.deb     │          │
│  │                                                              │          │
│  │  Installation Process:                                      │          │
│  │  • Extract package files                                    │          │
│  │  • Install to /opt/cvedix/monitor/                         │          │
│  │  • Update symlink in /usr/bin/                             │          │
│  │  • Preserve existing config (if compatible)                │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
│                              ▼                                              │
│                                                                             │
│  STEP 7: Start Service & Verify                                            │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  systemctl start metrics-monitor-system                      │          │
│  │  systemctl enable metrics-monitor-system                     │          │
│  │                                                              │          │
│  │  Verification:                                               │          │
│  │  • Check service status (systemctl status)                   │          │
│  │  • Test health endpoint (GET /health)                        │          │
│  │  • Verify API endpoints working                              │          │
│  │  • Check logs for errors                                     │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
│                              ▼                                              │
│                                                                             │
│  STEP 8: Update Status                                                     │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  Success:                                                     │          │
│  │  • Update version info                                       │          │
│  │  • Clean up old backups (keep last N versions)              │          │
│  │  • Report success to OTA Server                              │          │
│  │                                                              │          │
│  │  Failure:                                                    │          │
│  │  • Rollback to previous version                              │          │
│  │  • Restore config files                                     │          │
│  │  • Restart service                                           │          │
│  │  • Report error to OTA Server                               │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3. Rollback Mechanism

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ROLLBACK PROCESS                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Trigger Conditions:                                                       │
│  • Service fails to start after update                                     │
│  • Health check fails                                                       │
│  • Critical errors in logs                                                 │
│  • Manual rollback request                                                 │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  STEP 1: Stop Current Service                                 │          │
│  │  systemctl stop metrics-monitor-system                        │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                              ▼                                              │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  STEP 2: Restore Previous Version                            │          │
│  │  • Restore binary from /var/lib/metrics-monitor/backup/      │          │
│  │  • Restore config files                                       │          │
│  │  • Restore device config                                     │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                              ▼                                              │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  STEP 3: Reinstall Previous Package                          │          │
│  │  dpkg -i /var/lib/metrics-monitor/backup/*.deb               │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                              ▼                                              │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  STEP 4: Start Service                                        │          │
│  │  systemctl start metrics-monitor-system                       │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                              ▼                                              │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  STEP 5: Verify & Report                                      │          │
│  │  • Verify service is running                                  │          │
│  │  • Test endpoints                                              │          │
│  │  • Report rollback status to OTA Server                       │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4. OTA API Endpoints (Mô phỏng)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    OTA SERVER API ENDPOINTS                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  GET  /api/v1/updates/check                                                │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  Headers:                                                     │          │
│  │    Device-ID: <device-uuid>                                   │          │
│  │    Current-Version: <current-version>                         │          │
│  │                                                              │          │
│  │  Response:                                                    │          │
│  │    {                                                          │          │
│  │      "update_available": true/false,                         │          │
│  │      "latest_version": "1.2.0",                               │          │
│  │      "current_version": "1.1.0",                             │          │
│  │      "download_url": "https://...",                           │          │
│  │      "checksum": "sha256:...",                                │          │
│  │      "size": 1024000,                                         │          │
│  │      "release_notes": "...",                                 │          │
│  │      "required": false,                                       │          │
│  │      "compatibility": {...}                                   │          │
│  │    }                                                          │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
│  GET  /api/v1/updates/download                                             │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  Query Params:                                               │          │
│  │    version=<version>                                          │          │
│  │    device_id=<device-uuid>                                    │          │
│  │                                                              │          │
│  │  Response: Binary package file (.deb)                        │          │
│  │  Headers:                                                    │          │
│  │    Content-Type: application/vnd.debian.binary-package        │          │
│  │    Content-Length: <size>                                    │          │
│  │    X-Package-Checksum: sha256:<checksum>                     │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
│  POST /api/v1/updates/status                                               │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  Body:                                                        │          │
│  │    {                                                          │          │
│  │      "device_id": "<device-uuid>",                            │          │
│  │      "version": "1.2.0",                                     │          │
│  │      "status": "success|failed|rollback",                    │          │
│  │      "message": "...",                                       │          │
│  │      "timestamp": "2025-01-27T10:30:00Z"                     │          │
│  │    }                                                          │          │
│  │                                                              │          │
│  │  Response: { "status": "received" }                        │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5. Tính năng Bảo mật OTA

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    OTA SECURITY FEATURES                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────┐      ┌──────────────────────┐                     │
│  │  Package Signing      │      │  Checksum Verify   │                     │
│  │                      │      │                      │                     │
│  │  • GPG Signature     │      │  • SHA256 Checksum  │                     │
│  │  • Certificate Chain │      │  • Size Verification│                     │
│  │  • Signature Verify  │      │  • Integrity Check  │                     │
│  └──────────────────────┘      └──────────────────────┘                     │
│                                                                             │
│  ┌──────────────────────┐      ┌──────────────────────┐                     │
│  │  Secure Download     │      │  Authentication     │                     │
│  │                      │      │                      │                     │
│  │  • HTTPS Only        │      │  • Device ID        │                     │
│  │  • TLS 1.2+         │      │  • API Key          │                     │
│  │  • Certificate Pin  │      │  • Token-based      │                     │
│  └──────────────────────┘      └──────────────────────┘                     │
│                                                                             │
│  ┌──────────────────────┐      ┌──────────────────────┐                     │
│  │  Safe Installation   │      │  Rollback Support  │                     │
│  │                      │      │                      │                     │
│  │  • Atomic Updates   │      │  • Automatic        │                     │
│  │  • Transaction-based │      │  • Manual Trigger  │                     │
│  │  • Verification      │      │  • Version History  │                     │
│  └──────────────────────┘      └──────────────────────┘                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Tính năng Chính

### 1. Remote Device Operation
- **API-based Control**: Điều khiển thiết bị từ xa thông qua REST API
- **Authentication**: Basic Auth để bảo vệ các endpoint quan trọng
- **CORS Support**: Hỗ trợ truy cập từ web applications

### 2. OTA Updates
- **Over-The-Air Updates**: Cập nhật phần mềm từ xa
- **Safe Deployment**: Đảm bảo tính liên tục và an toàn cho hệ thống
- **Version Management**: Quản lý phiên bản và rollback

### 3. Flexible Configuration
- **JSON Configuration**: Cấu hình linh hoạt qua file JSON
- **Example Templates**: File mẫu `config.json.example` và `device_config.example.json`
- **Environment Variables**: Hỗ trợ override qua biến môi trường
- **Runtime Configuration**: Cấu hình động không cần restart

### 4. Systemd Integration
- **Service Management**: Tích hợp đầy đủ với systemd
- **Status Monitoring**: `systemctl status metrics-monitor-system`
- **Log Management**: `journalctl -u metrics-monitor-system`
- **Auto-start**: Tự động khởi động khi boot

### 5. Comprehensive Documentation
- **README.md**: Hướng dẫn sử dụng chi tiết
- **DEBIAN_PACKAGE.md**: Hướng dẫn build và cài đặt package
- **API Documentation**: Mô tả đầy đủ các endpoint
- **Configuration Guide**: Hướng dẫn cấu hình

## Kiến trúc Hệ thống

### Core Modules

1. **HTTP Server** (`main.cpp`)
   - RESTful API endpoints
   - Request routing và authentication
   - CORS handling

2. **System Info Module** (`system_info.cpp`)
   - Thu thập thông tin phần cứng qua hwinfo
   - CPU, RAM, GPU, Disk, Mainboard, OS information
   - Device metadata integration

3. **System Status Module** (`system_status.cpp`)
   - Real-time system metrics
   - CPU usage, RAM usage, Disk usage
   - Uptime tracking

4. **Device Config Module** (`device_config.cpp`)
   - Device registration và configuration
   - Persistent storage
   - Configuration validation

5. **Config Loader** (`config.cpp`)
   - JSON configuration parsing
   - Default values và validation
   - Runtime configuration management

### External Dependencies

- **hwinfo**: Cross-platform hardware information library
- **cpp-httplib**: Header-only HTTP server library
- **CMake**: Build system
- **Systemd**: Service management (runtime)

## Security Considerations

- **Authentication**: Basic Auth cho các endpoint quan trọng
- **Network Security**: Hỗ trợ binding đến localhost hoặc public IP
- **Input Validation**: Validate và sanitize tất cả inputs
- **Privilege Management**: Chạy với quyền phù hợp (không cần root cho hầu hết operations)

## Performance & Scalability

- **Lightweight**: Header-only dependencies, minimal footprint
- **Efficient**: Direct hardware access qua hwinfo
- **Low Latency**: Fast response times cho monitoring queries
- **Resource Friendly**: Tối ưu cho thiết bị IoT với tài nguyên hạn chế

